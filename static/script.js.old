function toggleDevice(device) {
    fetch(`/toggle/${device}`, { method: 'POST' })
    .then(response => response.json())
    .then(data => {
        document.getElementById(`${device}_status`).innerText = data.state ? "ON" : "OFF";
    });
}

function updateRules() {
    fetch('/update_rules', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            pump_enabled: document.getElementById('pump_enabled').checked,
            pump_on_time: document.getElementById('pump_on_time').value,
            pump_off_time: document.getElementById('pump_off_time').value,
            light_enabled: document.getElementById('light_enabled').checked,
            lux_threshold: document.getElementById('lux_threshold').value
        })
    }).then(response => response.json())
      .then(data => alert('Automation rules updated successfully!'));
}

setInterval(() => {
    fetch('/lux').then(res => res.json())
    .then(data => document.getElementById('lux').innerText = data.lux.toFixed(2));
}, 5000);

function updateRules() {
    const mode = document.getElementById("time_based_enabled").checked ? "time" : "light";

    const data = {
        mode: mode,
        time_on: document.getElementById("time_on").value,
        time_off: document.getElementById("time_off").value,
        time_pump: document.getElementById("time_pump").checked,
        time_light: document.getElementById("time_light").checked,
        lux_threshold: document.getElementById("lux_threshold").value,
        lux_pump: document.getElementById("lux_pump").checked,
        lux_light: document.getElementById("lux_light").checked
    };

    fetch("/update_rules", {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(resp => resp.json())
    .then(resp => alert("Rules updated successfully!"))
    .catch(err => alert("Failed to update rules: " + err));
}


function setupMutuallyExclusiveAutomation() {
    const pumpCheckbox = document.getElementById("pump_enabled");
    const lightCheckbox = document.getElementById("light_enabled");

    if (!pumpCheckbox || !lightCheckbox) {
        console.warn("Automation checkboxes not found");
        return;
    }

    pumpCheckbox.addEventListener("change", () => {
        if (pumpCheckbox.checked) {
            lightCheckbox.checked = false;
        }
    });

    lightCheckbox.addEventListener("change", () => {
        if (lightCheckbox.checked) {
            pumpCheckbox.checked = false;
        }
    });
}

// Call after DOM is loaded
document.addEventListener("DOMContentLoaded", setupMutuallyExclusiveAutomation);
